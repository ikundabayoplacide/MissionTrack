
paths:
  /expenselog:
    post:
      security:
        - bearerAuth: []
      tags:
        - Expense Logs
      summary: Create a new expense log
      description: |
        Create a new expense log. This endpoint accepts multipart/form-data allowing file uploads for accommodation, meals and transport receipts.
        Note: route is protected by authentication and role-based middleware in the server (see implementation for role checks).
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - missionId
                - date
              properties:
                missionId:
                  type: string
                  format: uuid
                  description: ID of the mission this expense log belongs to
                  example: "550e8400-e29b-41d4-a716-446655440000"
                date:
                  type: string
                  format: date
                  description: Date of expenses
                  example: "2024-01-15"
                accommodationFile:
                  type: string
                  format: binary
                  description: Upload accommodation receipt file (PDF or image)
                mealsFile:
                  type: string
                  format: binary
                  description: Upload meals receipt file (PDF or image)
                transportFile:
                  type: string
                  format: binary
                  description: Upload transport receipt file (PDF or image)
                description:
                  type: string
                  description: Additional description of expenses
                  example: "Daily expenses for business trip"
      responses:
        '201':
          description: Expense log created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /expenselogs:
    get:
      security:
        - bearerAuth: []
      tags:
        - Expense Logs
      summary: Get all expense logs
      description: Retrieve all expense logs. The actual results may be filtered by authenticated user's role on the server side.
      responses:
        '200':
          description: All expense logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /expenselog/{id}:
    parameters:
      - name: id
        in: path
        required: true
        description: Expense log ID
        schema:
          type: string
          format: uuid
    get:
      security:
        - bearerAuth: []
      tags:
        - Expense Logs
      summary: Get an expense log by ID
      responses:
        '200':
          description: Expense log retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Expense log not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      security:
        - bearerAuth: []
      tags:
        - Expense Logs
      summary: Update an expense log by ID
      description: Update fields and/or files for a given expense log. Accepts multipart/form-data. Only the provided fields will be updated.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                accommodationFile:
                  type: string
                  format: binary
                  description: Upload new accommodation receipt file
                mealsFile:
                  type: string
                  format: binary
                  description: Upload new meals receipt file
                transportFile:
                  type: string
                  format: binary
                  description: Upload new transport receipt file
                description:
                  type: string
                  description: Updated description of expenses
                  example: "Updated expense description"
               
      responses:
        '200':
          description: Expense log updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Expense log not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      security:
        - bearerAuth: []
      tags:
        - Expense Logs
      summary: Delete an expense log by ID
      responses:
        '200':
          description: Expense log deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Expense log not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /expenselogs/mission/{missionId}:
    get:
      security:
        - bearerAuth: []
      tags:
        - Expense Logs
      summary: Get expense logs by mission ID
      parameters:
        - name: missionId
          in: path
          required: true
          description: Mission ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Expense logs for mission retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /expenselog/status/{id}:
    patch:
      security:
        - bearerAuth: []
      tags:
        - Expense Logs
      summary: Change the status of an expense log
      description: Only users with financial manager role should be allowed to call this endpoint on the server-side (middleware enforces this).
      parameters:
        - name: id
          in: path
          required: true
          description: Expense log ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [pending, accepted, rejected]
                  description: New status for the expense log
                statusChangeComment:
                  type: string
                  description: Optional comment explaining the status change
                  example: "Receipt missing signature"
      responses:
        '200':
          description: Expense Log status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (insufficient role)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Expense log not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ExpenseLog:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
       
        missionId:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        accommodationAmount:
          type: number
          format: float
          example: 150.00
        mealsAmount:
          type: number
          format: float
          example: 45.50
        transportAmount:
          type: number
          format: float
          example: 25.00
        totalAmount:
          type: number
          format: float
          example: 220.50
        accommodationFile:
          type: string
          example: "/uploads/expense-logs/accommodation/accommodation-receipt-123.pdf"
          description: Path to accommodation receipt file
        mealsFile:
          type: string
          example: "/uploads/expense-logs/meals/meals-receipt-456.pdf"
          description: Path to meals receipt file
        transportFile:
          type: string
          example: "/uploads/expense-logs/transport/transport-receipt-789.pdf"
          description: Path to transport receipt file
        description:
          type: string
          example: "Daily expenses for business trip"
        date:
          type: string
          format: date
          example: "2024-01-15"
        status:
          type: string
          enum: [pending, accepted, rejected]
          example: pending
        statusChangeComment:
          type: string
          nullable: true
          example: null
        createdAt:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00.000Z"
        updatedAt:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00.000Z"

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Operation completed successfully"
        status:
          type: integer
          example: 200
        data:
          oneOf:
            - $ref: '#/components/schemas/ExpenseLog'
            - type: array
              items:
                $ref: '#/components/schemas/ExpenseLog'
            - type: object

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Internal server error"
        status:
          type: integer
          example: 500
        data:
          type: null
